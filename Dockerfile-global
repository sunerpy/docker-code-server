ARG TAG=noble
# 构建参数定义
ARG BUILD_IMAGE=ghcr.io/linuxserver/baseimage-ubuntu:noble
FROM ubuntu:$TAG AS xrdp-builder

RUN apt-get update && \
    DEBIAN_FRONTEND="noninteractive" apt-get install -y --no-install-recommends \
        autoconf \
        build-essential \
        ca-certificates \
        dpkg-dev \
        libpulse-dev \
        lsb-release \
        git \
        libtool \
        libltdl-dev \
        sudo && \
    rm -rf /var/lib/apt/lists/*

RUN git clone https://github.com/neutrinolabs/pulseaudio-module-xrdp.git /pulseaudio-module-xrdp
WORKDIR /pulseaudio-module-xrdp
RUN scripts/install_pulseaudio_sources_apt.sh && \
    ./bootstrap && \
    ./configure PULSE_DIR=$HOME/pulseaudio.src && \
    make && \
    make install DESTDIR=/tmp/install
# =============================================================================
# Code Server Docker 镜像构建文件
# 基于 LinuxServer.io 的 Ubuntu Noble 基础镜像构建开发环境
# =============================================================================

# =============================================================================
# 主构建阶段 - 安装所有开发工具和依赖
# =============================================================================
FROM ${BUILD_IMAGE} AS builder

# 设置非交互式安装模式，避免安装过程中的交互提示
ARG DEBIAN_FRONTEND="noninteractive"

# 版本标签和构建信息
ARG BUILD_DATE 
ARG VERSION
ARG CONDA_SCRIPT="Miniconda3-latest-Linux-x86_64.sh"
ARG CONDA_PATH="/usr/local/miniconda3"

# 镜像元数据标签
LABEL build_version="Linuxserver.io version:- ${VERSION} Build-date:- ${BUILD_DATE}"
LABEL maintainer="aptalca"

# =============================================================================
# 环境变量配置 - 设置开发环境所需的路径和配置
# =============================================================================
ENV HOME="/config" \
  GOPATH="/config/gopath" \
  GOPROXY="https://goproxy.cn,direct" \
  ZSH_CUSTOM="/config/.oh-my-zsh/custom"

ENV PATH="/config/.local/bin:${CONDA_PATH}/bin:$PATH"

# =============================================================================
# 系统依赖安装阶段 - 安装基础开发工具和库 可选
# =============================================================================
RUN echo "**** 更新包管理器并安装系统依赖 ****" && \
  apt-get update && \
  apt-get install -y \
  # 基础库和运行时依赖
  libreadline8 libncursesw6 liblzma5 libatomic1 \
  libssl-dev libsecret-1-0 libncurses5-dev libncursesw5-dev \
  libbz2-dev libreadline-dev libffi-dev libgdbm-dev libgdbm-compat-dev \
  # 构建工具
  build-essential clang-format \
  # 系统工具 不需要可不安装
  procps curl wget unzip rsync zip \
  inetutils-ping telnet net-tools netcat-openbsd \
  # 开发工具
  git subversion openssh-client \
  vim nano groff less \
  # Shell 和终端增强
  zsh zsh-syntax-highlighting zsh-autosuggestions \
  bash-completion fontconfig \
  # 中文字体支持
  fonts-noto-cjk fonts-noto-cjk-extra fonts-wqy-microhei fonts-wqy-zenhei \
  fonts-arphic-ukai fonts-arphic-uming \
  locales language-pack-zh-hans \
  # 编程语言和运行时
  openjdk-21-jdk-headless \
  # Python 开发依赖
  llvm xz-utils tk-dev \
  # 其他开发工具
  jq maven sudo \
  # aws容器镜像助手
  amazon-ecr-credential-helper skopeo \
  # 数据库工具
  pgloader \
  # Kerberos 配置
  krb5-config \
  # tarui工具
  libwebkit2gtk-4.1-dev \
  libgtk-3-dev \
  libayatana-appindicator3-dev \
  librsvg2-dev \
  xvfb \
  clang \
  nsis \
  lld \
  tree \
  --no-install-recommends && \
  # 清理不需要的包
  apt-get remove -y debian-keyring debian-archive-keyring apt-transport-https && \
  # 配置 sudo 权限
  sed -i '/root.*ALL/aabc ALL=(ALL:ALL) NOPASSWD: ALL' /etc/sudoers && \
  # 配置中文 locale
  locale-gen zh_CN.UTF-8 && \
  update-locale LANG=zh_CN.UTF-8 && \
  echo "**** 系统依赖安装完成 ****"

# =============================================================================
# Code Server 安装阶段 - 下载并安装最新版本的 code-server
# =============================================================================
RUN echo "**** 安装 Code Server ****" && \
  # 获取最新版本号
  if [ -z ${CODE_RELEASE+x} ]; then \
  CODE_RELEASE=$(curl -sX GET https://api.github.com/repos/coder/code-server/releases/latest \
  | awk '/tag_name/{print $4;exit}' FS='[""]' | sed 's|^v||'); \
  fi && \
  echo "安装 Code Server 版本: ${CODE_RELEASE}" && \
  # 创建安装目录
  mkdir -p /app/code-server && \
  # 下载并解压 code-server
  curl -o /tmp/code-server.tar.gz -L \
  "https://github.com/coder/code-server/releases/download/v${CODE_RELEASE}/code-server-${CODE_RELEASE}-linux-amd64.tar.gz" && \
  tar xf /tmp/code-server.tar.gz -C /app/code-server --strip-components=1 && \
  echo "**** Code Server 安装完成 ****"

# =============================================================================
# Miniconda 安装阶段 - 安装 Python 包管理器
# =============================================================================
RUN echo "**** 安装 Miniconda ****" && \
  cd /tmp && \
  curl -o /tmp/miniconda.sh -L "https://repo.anaconda.com/miniconda/${CONDA_SCRIPT}" && \
  bash miniconda.sh -b -u -p ${CONDA_PATH} && \
  # 初始化 conda 环境
  ${CONDA_PATH}/bin/conda init bash && \
  echo "**** Miniconda 安装完成 ****"

# =============================================================================
# Shell 环境配置阶段 - 安装和配置 Oh My Zsh 及主题
# =============================================================================
RUN echo "**** 配置 Zsh 和 Oh My Zsh ****" && \
  # 安装 Oh My Zsh
  echo "y" | sh -c "$(curl -fsSL https://raw.githubusercontent.com/ohmyzsh/ohmyzsh/master/tools/install.sh)" && \
  # 安装语法高亮插件
  git clone https://github.com/zsh-users/zsh-syntax-highlighting.git \
  ${ZSH_CUSTOM:-~/.oh-my-zsh/custom}/plugins/zsh-syntax-highlighting && \
  # 安装 Powerlevel10k 主题
  git clone --depth=1 https://github.com/romkatv/powerlevel10k.git \
  ${ZSH_CUSTOM:-$HOME/.oh-my-zsh/custom}/themes/powerlevel10k && \
  # 配置主题
  echo 'source ~/powerlevel10k/powerlevel10k.zsh-theme' >>~/.zshrc && \
  # 设置默认 shell
  chsh -s /bin/zsh && \
  # 刷新字体缓存
  fc-cache -f -v && \
  echo "**** Zsh 配置完成 ****"

# =============================================================================
# 字体安装阶段 - 复制 Meslo 字体文件并刷新字体缓存
# =============================================================================
COPY font/* /usr/local/share/fonts/meslo/

RUN echo "**** 刷新字体缓存 ****" && \
  fc-cache -f -v && \
  echo "**** 字体缓存刷新完成 ****"

# =============================================================================
# 系统配置阶段 - 配置环境变量和系统设置
# =============================================================================
RUN echo "**** 配置系统环境 ****" && \
  # 设置历史记录大小
  echo 'HISTSIZE=100000' >> /etc/profile && \
  # 配置 PATH 环境变量
  echo "export PATH=\"\$PATH\"" >> /etc/profile && \
  # 应用配置
  . /etc/profile && \
  # 更新动态链接库缓存
  /sbin/ldconfig -v && \
  echo "**** 系统环境配置完成 ****"

# =============================================================================
# Python 包管理工具安装阶段 - 安装现代 Python 包管理器 uv
# =============================================================================
RUN echo "**** 安装 UV Python 包管理器 ****" && \
  curl -LsSf https://astral.sh/uv/install.sh | sh && \
  echo "**** UV 安装完成 ****"

# =============================================================================
# AWS CLI 安装阶段 - 安装 Amazon Web Services 命令行工具
# =============================================================================
RUN echo "**** 安装 AWS CLI v2 ****" && \
  curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o /tmp/awscliv2.zip && \
  cd /tmp && \
  unzip awscliv2.zip && \
  rm -f awscliv2.zip && \
  ./aws/install && \
  echo "**** AWS CLI 安装完成 ****"

# =============================================================================
# 配置文件复制阶段 - 复制自定义配置文件
# =============================================================================
# 复制自定义 OpenSSL 配置
COPY openssl.cnf /etc/ssl/openssl.cnf

# 复制根目录配置文件和脚本
COPY /root /

COPY --chmod=755 scripts/run_novnc /run_novnc
COPY --chmod=755 scripts/start.sh /custom-services.d/start.sh
# COPY --chmod=755 scripts/vnc-run /custom-services.d/vnc-run
# # COPY --chmod=755 scripts/run-no-vnc /custom-services.d/run-no-vnc
ENV USER="abc" \
  DISPLAY=:1 \
  LANG=zh_CN.UTF-8 \
  LANGUAGE=zh_CN:zh:en_US:en \
  LC_ALL=zh_CN.UTF-8 \
  VNC_PASSWD=password \
  VNC_PORT=5900 \
  VNC_RESOLUTION=1200x800 \
  VNC_COL_DEPTH=24  \
  NOVNC_PORT=6080 \
  VNC_HOME=/vnc \
  NOVNC_HOME=/noVNC

RUN set -xe \
  && apt-get update && apt-get install -y \
  # X11 和字体
  xfonts-base xfonts-75dpi xfonts-100dpi xfonts-scalable xfonts-cyrillic \
  # XFCE 桌面环境
  xfce4 xfce4-goodies xfce4-terminal xfce4-pulseaudio-plugin \
  # 辅助功能
  at-spi2-core dbus-x11 \
  # RDP 支持（xorgxrdp 是 xrdp 的 Xorg 后端模块）
  xorgxrdp xrdp pavucontrol pulseaudio pulseaudio-utils \
  # VNC 支持（可选，用于 noVNC）
  tightvncserver x11vnc xvfb \
  # X11 工具
  x11-apps x11-utils x11-xserver-utils xauth \
  # 音频支持
  libasound2-dev \
  # 终端和 SSH
  xterm openssh-server \
  --no-install-recommends \
  && mkdir -p ${HOME}/.vnc /custom-services.d ${NOVNC_HOME} ${VNC_HOME}/x11vnc ${VNC_HOME}/vnc ${VNC_HOME}/log /var/run/sshd /run/sshd && \
  mkdir -p ${NOVNC_HOME}/utils/websockify &&\
  wget -qO- "https://github.com/novnc/noVNC/archive/$( \
  curl -s https://api.github.com/repos/novnc/noVNC/releases/latest | jq -r .tag_name \
  ).tar.gz" | tar xz --strip 1 -C ${NOVNC_HOME} \
  && wget -qO- "https://github.com/novnc/websockify/archive/$( \
  curl -s https://api.github.com/repos/novnc/websockify/releases/latest | jq -r .tag_name \
  ).tar.gz" | tar xzf - --strip 1 -C ${NOVNC_HOME}/utils/websockify &&\
  ln -s ${NOVNC_HOME}/vnc_auto.html ${NOVNC_HOME}/index.html &&\
  chown -R ${USER}:${USER} ${NOVNC_HOME} &&\
  chown -R ${USER}:${USER} ${VNC_HOME} && \
  sed -i \
  -e 's/^#\?\s*PasswordAuthentication\s\+.*/PasswordAuthentication no/' \
  -e 's/^#\?\s*PermitRootLogin\s\+.*/PermitRootLogin no/' \
  -e 's/^#\?\s*PubkeyAuthentication\s\+.*/PubkeyAuthentication yes/' \
  /etc/ssh/sshd_config && \
  sed -i 's/^#\?Port .*/Port 22/' /etc/ssh/sshd_config && \
  chmod -x /etc/update-motd.d/* && \
  usermod -s /bin/zsh abc

RUN curl https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg &&\
  install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/ &&\
  echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft.gpg] https://packages.microsoft.com/repos/edge stable main" \
  | sudo tee /etc/apt/sources.list.d/microsoft-edge.list &&\
  apt update && apt install -y microsoft-edge-stable --no-install-recommends &&\
  # 创建 Edge 启动包装脚本（禁用沙箱以在容器中运行）
  printf '#!/bin/bash\nexec /usr/bin/microsoft-edge-stable --no-sandbox --disable-dev-shm-usage --disable-gpu --disable-software-rasterizer --disable-setuid-sandbox "$@"\n' > /usr/local/bin/edge-browser &&\
  chmod +x /usr/local/bin/edge-browser &&\
  # 设置 Edge 为默认浏览器
  update-alternatives --install /usr/bin/x-www-browser x-www-browser /usr/local/bin/edge-browser 200 &&\
  update-alternatives --set x-www-browser /usr/local/bin/edge-browser &&\
  update-alternatives --install /usr/bin/gnome-www-browser gnome-www-browser /usr/local/bin/edge-browser 200 &&\
  update-alternatives --set gnome-www-browser /usr/local/bin/edge-browser &&\
  # 创建自定义 desktop 文件
  mkdir -p /usr/share/applications &&\
  printf '[Desktop Entry]\nVersion=1.0\nName=Microsoft Edge (Container)\nComment=Web Browser optimized for containers\nExec=/usr/local/bin/edge-browser %%U\nTerminal=false\nType=Application\nIcon=microsoft-edge\nCategories=Network;WebBrowser;\nMimeType=text/html;text/xml;application/xhtml+xml;x-scheme-handler/http;x-scheme-handler/https;\n' > /usr/share/applications/edge-browser.desktop &&\
  # 创建 xdg-open 配置
  mkdir -p /etc/xdg &&\
  echo "[Default Applications]" > /etc/xdg/mimeapps.list &&\
  echo "text/html=edge-browser.desktop" >> /etc/xdg/mimeapps.list &&\
  echo "x-scheme-handler/http=edge-browser.desktop" >> /etc/xdg/mimeapps.list &&\
  echo "x-scheme-handler/https=edge-browser.desktop" >> /etc/xdg/mimeapps.list &&\
  echo "x-scheme-handler/about=edge-browser.desktop" >> /etc/xdg/mimeapps.list &&\
  echo "x-scheme-handler/unknown=edge-browser.desktop" >> /etc/xdg/mimeapps.list &&\
  # 设置 BROWSER 环境变量
  echo 'export BROWSER=/usr/local/bin/edge-browser' >> /etc/profile &&\
  echo 'export BROWSER=/usr/local/bin/edge-browser' >> /etc/bash.bashrc

COPY --from=xrdp-builder /tmp/install /
RUN sed -i 's|^Exec=.*|Exec=/usr/bin/pulseaudio|' /etc/xdg/autostart/pulseaudio-xrdp.desktop
# =============================================================================
# 最终清理阶段 - 清理临时文件和缓存
# =============================================================================
RUN echo "**** 执行最终清理 ****" && \
  # 清理 APT 缓存
  apt-get clean && \
  # 清理临时文件和缓存
  rm -rf \
  /config/* \
  /tmp/* \
  /var/lib/apt/lists/* \
  /var/tmp/* && \
  # 清理 Python 缓存和测试文件
  find /usr/local -depth \( \
  \( -type d -a \( -name test -o -name tests -o -name idle_test \) \) -o \
  \( -type f -a \( -name '*.pyc' -o -name '*.pyo' -o -name 'libpython*.a' \) \) \
  \) -exec rm -rf '{}' + && \
  echo "**** 清理完成 ****"

# =============================================================================
# 端口暴露 - 暴露 Code Server 服务端口
# =============================================================================
EXPOSE 8443 5901

# =============================================================================
# 构建完成
# 此镜像包含了完整的开发环境：
# - Code Server (基于 VS Code 的 Web IDE)
# - Python 开发环境 (Miniconda + uv)
# - Java 开发环境 (OpenJDK 21)
# - Go 开发环境支持
# - Shell 增强 (Zsh + Oh My Zsh + Powerlevel10k)
# - 各种开发工具和实用程序
# - AWS CLI 和容器工具
# 容器启动后，可使用包管理软件mise或asdf来管理不同版本的node python go rust等语言环境
# =============================================================================
